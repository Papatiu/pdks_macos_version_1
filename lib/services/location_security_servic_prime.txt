import 'dart:async';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:geolocator/geolocator.dart';
import 'package:shared_preferences/shared_preferences.dart';

// GÃœVENÄ°LÄ°R VE AYRI PAKETLERÄ° Ä°MPORT EDÄ°YORUZ
import 'package:flutter_jailbreak_detection/flutter_jailbreak_detection.dart';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:sensors_plus/sensors_plus.dart';

// YENÄ° OLUÅTURDUÄUMUZ VE AYRI BÄ°R DOSYADA DURAN AÄ GÃœVENLÄ°K SERVÄ°SÄ°NÄ° Ä°MPORT EDÄ°YORUZ
import 'package:mobilperosnel/services/network_security_service.dart';

class LocationSecurityService {
  
  /// Konumun gÃ¼venilir olup olmadÄ±ÄŸÄ±nÄ± 4 katmanlÄ± bir sistemle kontrol eder.
  /// `true` -> GÃ¼venilir, `false` -> ÅÃ¼pheli
  static Future<bool> isLocationTrustworthy(Position currentPosition) {
    if (Platform.isIOS) {
      return _isIosLocationTrustworthy(currentPosition);
    }
    return Future.value(true); 
  }

  /// Sadece iOS iÃ§in profesyonel sahte konum kontrollerini yapar.
  static Future<bool> _isIosLocationTrustworthy(Position currentPosition) async {
    
    // --- KATMAN 1: CÄ°HAZ BÃœTÃœNLÃœÄÃœ KONTROLÃœ ---
    try {
      if (await FlutterJailbreakDetection.jailbroken) {
        debugPrint("ğŸš¨ GÃœVENLÄ°K Ä°HLALÄ°: Cihaz Jailbreak'li!");
        return false;
      }
      
      DeviceInfoPlugin deviceInfo = DeviceInfoPlugin();
      IosDeviceInfo iosInfo = await deviceInfo.iosInfo;
      if (!iosInfo.isPhysicalDevice) {
        debugPrint("ğŸš¨ GÃœVENLÄ°K Ä°HLALÄ°: Uygulama bir SimÃ¼latÃ¶r'de Ã§alÄ±ÅŸÄ±yor!");
        // Not: CanlÄ±ya Ã§Ä±karken bu satÄ±rÄ±n aktif olmasÄ± Ã¶nemlidir.
        // Test aÅŸamasÄ±nda, simÃ¼latÃ¶rde Ã§alÄ±ÅŸabilmek iÃ§in bu satÄ±rÄ± yoruma alabilirsiniz.
        // return false; 
      }
    } catch (e) {
      debugPrint("Cihaz bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kontrolÃ¼ sÄ±rasÄ±nda hata: $e");
      return false;
    }

    // --- YENÄ° EKLENEN KATMAN 2: AÄ VERÄ°SÄ° VE IP ANALÄ°ZÄ° ---
    // AyrÄ± dosyada duran NetworkSecurityService'i burada Ã§aÄŸÄ±rÄ±yoruz.
    if (!await NetworkSecurityService.isNetworkLocationConsistent(currentPosition)) {
      debugPrint("ğŸš¨ AÄ Ä°HLALÄ°: GPS ve IP konumlarÄ± arasÄ±nda tutarsÄ±zlÄ±k tespit edildi!");
      return false; // Konumlar tutarsÄ±zsa, gÃ¼venme ve diÄŸer kontrollere geÃ§me.
    }

    // --- KATMAN 3: SENSÃ–R VERÄ°SÄ° ANALÄ°ZÄ° ---
    if (currentPosition.speed > 1) { 
      final isDeviceActuallyMoving = await _isDeviceActuallyMoving();
      if (!isDeviceActuallyMoving) {
        debugPrint("ğŸš¨ SENSÃ–R TUTARSIZLIÄI: Konum hareketli ama cihaz sensÃ¶rleri durgun!");
        return false;
      }
    }

    // --- KATMAN 4: DAVRANIÅSAL ANALÄ°Z (AKILLI HIZ KONTROLÃœ) ---
    final prefs = await SharedPreferences.getInstance();
    return _isSpeedReasonable(prefs, currentPosition);
  }

  /// HÄ±z kontrolÃ¼ mantÄ±ÄŸÄ±nÄ± iÃ§eren yardÄ±mcÄ± fonksiyon.
  static Future<bool> _isSpeedReasonable(SharedPreferences prefs, Position currentPosition) async {
    final double? lastLat = prefs.getDouble('secure_loc_last_lat');
    final double? lastLng = prefs.getDouble('secure_loc_last_lng');
    final int? lastTimeMillis = prefs.getInt('secure_loc_last_time');

    if (lastLat == null || lastLng == null || lastTimeMillis == null ||
        DateTime.now().difference(DateTime.fromMillisecondsSinceEpoch(lastTimeMillis)).inMinutes > 5) {
      await _saveLastPosition(prefs, currentPosition);
      debugPrint("ğŸ•µï¸â€â™‚ï¸ [HÄ±z KontrolÃ¼] Yeni referans noktasÄ± ayarlandÄ±.");
      return true;
    }
    
    final DateTime lastPositionTime = DateTime.fromMillisecondsSinceEpoch(lastTimeMillis);
    final double distance = Geolocator.distanceBetween(lastLat, lastLng, currentPosition.latitude, currentPosition.longitude);
    final double timeDiffInSeconds = DateTime.now().difference(lastPositionTime).inMilliseconds / 1000.0;
    
    if (timeDiffInSeconds < 1) {
       await _saveLastPosition(prefs, currentPosition);
       return true;
    }
    
    final double speed = distance / timeDiffInSeconds;
    const double maxReasonableSpeedMs = 140; 

    if (speed > maxReasonableSpeedMs) {
      debugPrint("ğŸš¨ HIZ Ä°HLALÄ°: Anormal hÄ±z tespit edildi ($speed m/s).");
      return false;
    }

    await _saveLastPosition(prefs, currentPosition);
    return true;
  }
  
  /// CihazÄ±n ivmeÃ¶lÃ§erini dinleyerek gerÃ§ekten hareket edip etmediÄŸini kontrol eder.
  static Future<bool> _isDeviceActuallyMoving() async {
    final completer = Completer<bool>();
    late StreamSubscription subscription;
    const double movementThreshold = 0.5;
    
    subscription = accelerometerEventStream().listen((AccelerometerEvent event) {
        double netAcceleration = (event.x.abs() + event.y.abs() + event.z.abs()) - 9.8;
        if (netAcceleration.abs() > movementThreshold) {
            if (!completer.isCompleted) {
              debugPrint("âœ… SENSÃ–R: Cihazda fiziksel hareket tespit edildi.");
              completer.complete(true);
              subscription.cancel();
            }
        }
    });

    Future.delayed(const Duration(milliseconds: 1500), () {
      if (!completer.isCompleted) {
        debugPrint("âš ï¸ SENSÃ–R: Belirlenen sÃ¼rede yeterli fiziksel hareket tespit edilemedi.");
        completer.complete(false);
        subscription.cancel();
      }
    });

    return completer.future;
  }

  /// Konum ve zamanÄ± SharedPreferences'a kaydeder.
  static Future<void> _saveLastPosition(SharedPreferences prefs, Position position) async {
    await prefs.setDouble('secure_loc_last_lat', position.latitude);
    await prefs.setDouble('secure_loc_last_lng', position.longitude);
    await prefs.setInt('secure_loc_last_time', DateTime.now().millisecondsSinceEpoch);
  }
}